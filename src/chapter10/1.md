# クロージャ
クロージャは、その場の変数を捕まえる(キャプチャする)ことができる無名関数です。

## 基本的な使い方
```rust
// 普通の関数
fn add_normal(x: i32, y: i32) -> i32 {
    x + y
}

fn main() {
    let a = 10;
    let b = 20;

    // クロージャの場合
    let add_closure = |x, y| x + y; 

    println!("{}", add_normal(a, b));
    println!("{}", add_closure(a, b));
}
```

## 環境のキャプチャ(変数を捕まえる)
定義されたスコープ外にある変数を使うことができる
```rust
fn main() {
    let factor = 10;

    let multiply = |x| x * factor;

    println!("{}", multiply(2));
}
```

## キャプチャのモード
クロージャが変数を「どう扱うか」によって、自動的に3種類のトレイトのどれかに分類されます。
|トレイト|意味|動作イメージ|
|---|---|---|
|`Fn`|不変借用`&T`|変数をただ読むだけ|
|`FnMut`|可変借用`&mut T`|変数を書き換える。クロージャ自体も`mut`が必要|
|`FnOnce`|所有権の移動`T`|変数を「消費」する。|

### Fn(読み取り)
```rust
fn main() {
    let s = "Hello".to_string();
    let print_it = || println!("{}", s); // sを借用して読むだけ

    println!("{}", s);
    println!("{}", s); // 何度も呼べる
}
```

### FnMut(書き換え)
```rust
fn main() {
    let mut count = 0;

    let mut inc = || {
        count += 1;
        println!("COUNT: {}", count)
    };

    inc();
    inc();
}
```

### FnOnce(消費)
```rust
fn main() {
    let s = "Hello".to_string();
    let consume_it = || {
        let taken = s; // 所有権がムーブ
        println!("{}", taken);
    };

    consume_it();
    // consume_it(); // ここでエラー
}
```

## move
クロージャの前に`move`を付けると、使用する変数の所有権を、強制的にクロージャ内に移動させることができます。

主に後に学ぶマルチスレッドで必須です。

構造体にクロージャを保持させる際にも必要です。

```rust
// 構造体にジェネリクス
struct Handler<F> // クロージャは慣例的にF
where             // 構造体にももちろん境界を付けれる
    F: Fn(),      // Fn(読み取り)を実装していることを境界に
{
    f: F,
}

fn main() {
    let text = String::from("Hello");

    // Fnなので自動的にFnが実装される
    let h = Handler {
        f: move || {
            println!("{}", text);
        },
    };

    // (h.f)で、まずフィールドを評価して値にする
    (h.f)();
}
```